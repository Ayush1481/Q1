import sqlite3
import pandas as pd
import json

# 1. Connect to SQLite and load data
conn = sqlite3.connect("retailpro.db")
cursor = conn.cursor()

# 2. Execute the SQL script to create and populate the table
with open("q-sql-correlation-github-pages.sql", "r") as f:
    sql_script = f.read()
cursor.executescript(sql_script)
conn.commit()

# 3. Load data into pandas DataFrame
df = pd.read_sql_query("SELECT * FROM retail_data", conn)

# 4. Calculate required correlations
corr_returns_netsales = df["Returns"].corr(df["Net_Sales"])
corr_returns_promospend = df["Returns"].corr(df["Promo_Spend"])
corr_netsales_promospend = df["Net_Sales"].corr(df["Promo_Spend"])

# 5. Store results in a dictionary
correlations = {
    "Returns-Net_Sales": corr_returns_netsales,
    "Returns-Promo_Spend": corr_returns_promospend,
    "Net_Sales-Promo_Spend": corr_netsales_promospend
}

# 6. Find the strongest correlation by absolute value
strongest_pair = max(correlations, key=lambda k: abs(correlations[k]))

# 7. Create final JSON result
result = {
    "pair": strongest_pair,
    "correlation": correlations[strongest_pair]
}

# 8. Print the result for verification
print(result)

# 9. Save as result.json
with open("result.json", "w") as f:
    json.dump(result, f)

# 10. Close the database connection
conn.close()
